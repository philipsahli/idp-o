apiVersion: workflow.dev/v1
kind: Workflow
metadata:
  name: deploy-app
  description: Deploy application with full GitOps pipeline including Git repository and ArgoCD onboarding
spec:
  steps:
    - name: create-git-repository
      type: gitea-repo
      repoName: "${metadata.name}"
      description: "Application repository for ${metadata.name}"
      owner: "platform-team"

    - name: generate-s3-terraform
      type: terraform-generate
      if: "resources.s3-bucket != null"
      resource: s3
      outputDir: workspaces/${metadata.name}/terraform
      variables:
        bucket_name: ${metadata.name}-storage
        minio_endpoint: http://minio.minio-system.svc.cluster.local:9000
        minio_user: minioadmin
        minio_password: minioadmin

    - name: provision-s3-bucket
      type: terraform
      if: "resources.s3-bucket != null"
      operation: apply
      workingDir: workspaces/${metadata.name}/terraform
      outputs:
        - minio_url
        - bucket_name
        - endpoint
        - bucket_arn

    - name: provision-infrastructure
      type: terraform
      path: "./terraform/infra"

    - name: deploy-application
      type: kubernetes
      namespace: "${metadata.name}-${environment.type}"

    - name: commit-manifests-to-git
      type: git-commit-manifests
      repoName: "${metadata.name}"
      manifestPath: "manifests"

    - name: onboard-to-argocd
      type: argocd-app
      appName: "${metadata.name}-${environment.type}"
      repoName: "${metadata.name}"
      targetPath: "manifests"
      namespace: "${metadata.name}-${environment.type}"
      syncPolicy: "auto"

 #  - name: configure-monitoring
 #     type: ansible
 #     path: "./ansible"
 #     playbook: "monitoring-setup.yml"

    - name: verify-deployment
      type: policy
      config:
        script: |
          #!/bin/bash
          set -e
          echo "üîç Verifying deployment status for: ${metadata.name}"

          NAMESPACE="${metadata.name}-${environment.type}"

          # Wait for deployment to be ready
          echo "Waiting for deployment to be ready..."
          kubectl wait --for=condition=available --timeout=300s deployment/${metadata.name} -n ${NAMESPACE} || echo "Deployment may still be in progress"

          # Check pod status
          echo "Pod status:"
          kubectl get pods -n ${NAMESPACE} -l app=${metadata.name}

          # Check service status
          echo "Service status:"
          kubectl get svc -n ${NAMESPACE}

          # Verify S3 environment variables if S3 bucket was provisioned
          echo ""
          echo "Checking for S3 configuration..."
          POD_NAME=$(kubectl get pods -n ${NAMESPACE} -l app=${metadata.name} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          if [ -n "$POD_NAME" ]; then
              echo "Verifying environment variables in pod: $POD_NAME"
              if kubectl exec -n ${NAMESPACE} $POD_NAME -- env | grep -q S3_BUCKET_ENDPOINT; then
                  echo "‚úÖ S3 configuration found in pod:"
                  kubectl exec -n ${NAMESPACE} $POD_NAME -- env | grep S3_ | sed 's/^/  /'
              else
                  echo "‚ÑπÔ∏è  No S3 configuration found (not required)"
              fi
          fi

          echo ""
          echo "‚úÖ Deployment verification completed"